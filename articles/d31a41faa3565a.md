---
title: "Edge Runtimeã§å‹•ã‹ã™Next.js Ã— GraphQL Ã— ç”ŸæˆAIã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¥é–€"
emoji: "â­ï¸"
type: "tech"
topics:
  [
    "nextjs",
    "typescript",
    "graphql",
    "generativeai",
    "edge-runtime",
    "docker",
    "postgresql",
  ]
published: true
---

# ã¯ã˜ã‚ã« (à¸…â€¢Ï‰â€¢à¸…)

ã€Œã¨ã‚Šã‚ãˆãš Vercel ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚Œã°ã„ã„ã£ã—ã‚‡ â˜…ã€ã§å§‹ã‚ãŸå€‹äººé–‹ç™ºãŒã€æ°—ã¥ã‘ã° **ãƒžãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ SaaS** ã«é€²åŒ–ã—ã¦ã—ã¾ã†â€•â€•ãã‚“ãªçµŒé¨“ã€ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ

ä»Šæ—¥ã¯ã‚ªã‚¿ã‚¯ç³»ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å¥³å­ã®ã‚ãŸã—ãŒ â¤ï¸â€ðŸ”¥ **Next.js 15 ã® Edge Runtime + TypeScript + GraphQL + PostgreSQL** ã«åŠ ãˆã€ç”Ÿæˆ AI ã‚’ã‚¹ãƒ‘ã‚¤ã‚¹ã«ã—ãŸ â€œã‚®ãƒ¼ã‚¯ã®ãŸã‚ã®ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯æ§‹æˆâ€ ã‚’èªžã‚Šã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã¨ AI ã®çµ„ã¿åˆã‚ã›ã«ãƒ¢ã‚¨ãƒ¢ã‚¨ã—ã¤ã¤ã€æŠ½è±¡åº¦é«˜ã‚ã«è¨­è¨ˆæˆ¦ç•¥ã‚’è¦—ã„ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

# ç›®æ¬¡

1. ãƒ†ãƒ¼ãƒžã®èƒŒæ™¯
2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨æ™¯å›³ã¨æŠ€è¡“é¸å®š
3. Edge Functions ã§ GraphQL ã‚’ã•ã°ãã‚³ãƒ„
4. ç”Ÿæˆ AI ãƒ¬ã‚¤ãƒ¤ã®é…ç½®ã¨è²¬å‹™åˆ†é›¢
5. Docker Ã— pgvector ã§ Embedding ã‚’é«˜é€ŸåŒ–
6. CI/CD ã¨ Observability å°æŠ€é›†
7. ã¾ã¨ã‚ã¨æŽ¨ã—ãƒã‚¤ãƒ³ãƒˆ

---

## 1. ãƒ†ãƒ¼ãƒžã®èƒŒæ™¯

2025 å¹´ã¯ **Edge First** ã¸å®Œå…¨ã‚·ãƒ•ãƒˆã®å¹´ã€‚å¾“æ¥ã® Node ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã¯ **ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆ** ãŒãƒãƒƒã‚¯ã§ã—ãŸãŒã€Edge Runtime + Bun + WASM ã®ç™»å ´ã§ _sub-100 ms_ ãŒå½“ãŸã‚Šå‰ã«ã€‚

ãã“ã¸ **LLM ã‚¢ãƒ—ãƒª** ãƒ–ãƒ¼ãƒ ãŒé‡ãªã‚Šã€ã€Œä½Žãƒ¬ã‚¤ãƒ†ãƒ³ã‚· + ãƒ‡ãƒ¼ã‚¿é‡è¦–ã€ã®æ§‹æˆã‚’çœŸé¢ç›®ã«è€ƒãˆç›´ã™å¿…è¦ãŒå‡ºã¦ããŸã‚ã‘ã§ã™ã€‚( á¢ Ë™ê’³Ë™ á¢ )

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨æ™¯å›³ã¨æŠ€è¡“é¸å®š

```
Client (Next.js App Router)
        â”‚  /app/api/chat/route.ts
        â–¼
Edge Function (GraphCDN) â”€â”  â† Streaming
                           â”œâ”€â†’ pgvector@Neon (R/W Split)
        â–²                  â”‚
        â”‚                  â””â”€â†’ OpenAI Function Calling
React Server Components â”€â”€â”˜

```

- **Next.js 15**: App Router + RSC ã§ UX ã¨ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ä¸¡ç«‹
- **GraphQL Yoga** on **Edge**: ã‚¹ã‚­ãƒ¼ãƒžãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã§åž‹å®‰å…¨ã€DataLoader ã‚‚æ¥½å‹
- **PostgreSQL 16 + pgvector**: åŸ‹ã‚è¾¼ã¿æ¤œç´¢ã‚’ SQL ã«çµ±åˆã€Docker Compose ã§ãƒ­ãƒ¼ã‚«ãƒ«å®Œçµ
- **LangChain.js**: LLM ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æœ€å°ã‚³ãƒ¼ãƒ‰ã§è¨˜è¿°
- **OpenTelemetry + Sentry**: ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã¨ã‚¨ãƒ©ãƒ¼ç›£è¦–ã‚’ä¸€å…ƒåŒ– â­ï¸

## 3. Edge Functions ã§ GraphQL ã‚’ã•ã°ãã‚³ãƒ„

Edge Runtime ã¯ **fetch ãƒ™ãƒ¼ã‚¹ I/O** ãªã®ã§ `@whatwg-node/fetch` ã«çµ±ä¸€ã™ã‚‹ã®ãŒå‰ã€‚

DataLoader ã§ N+1 ã‚’æ½°ã™ã¨ãã€`Map` ã®ã‚­ãƒ¼ã¯ **TenantID + QueryKey** ã«ã™ã‚‹ã¨ãƒžãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚’å®‰å…¨ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ãã¾ã™ã€‚

ã•ã‚‰ã« `defer` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§ RSC ã¨é€£æºã•ã›ã‚‹ã¨ã€ðŸ‘§ðŸ» ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒ _çˆ†é€Ÿæ„Ÿ_ ã«ãªã‚Šã¾ã™ã€‚

## 4. ç”Ÿæˆ AI ãƒ¬ã‚¤ãƒ¤ã®é…ç½®ã¨è²¬å‹™åˆ†é›¢

AI ãŒçµ¡ã‚€ã¨ã€Œã©ã“ã§æŽ¨è«–ã‚’å‘¼ã¶ã‹ã€ãŒæ³¥æ²¼åŒ–ã—ãŒã¡ã€‚ã‚ãŸã—ã¯ **Use-case å±¤** ã‚’æ¬¡ã® 3 ã¤ã«åˆ†å‰²ã—ã¦ã„ã¾ã™ã€‚

1. **Retriever**: pgvector ã§ Top-k ã‚’æ‹¾ã†
2. **Reasoner**: OpenAI GPT-4o ã‚’ Function Calling ã§å©ã
3. **Composer**: GraphQL Mutation / Subscription ã«çµæžœã‚’æµã™

ã“ã†ã™ã‚‹ã“ã¨ã§ **LLM ã‚’â€œä½Žçµåˆãªãƒ—ãƒ©ã‚¬ãƒ–ãƒ«ã‚µãƒ¼ãƒ“ã‚¹â€** ã¨ã—ã¦æ‰±ãˆã¾ã™ã€‚âš ï¸ AI éƒ¨åˆ†ã‚’ãƒ¢ãƒŽãƒªã‚¹ã«åŸ‹ã‚è¾¼ã‚€ã¨ã€ãƒ¢ãƒ‡ãƒ«å·®ã—æ›¿ãˆã§åœ°ç„ã‚’è¦‹ã‚‹ã®ã§æ³¨æ„ã€‚

## 5. Docker Ã— pgvector ã§ Embedding ã‚’é«˜é€ŸåŒ–

ãƒ­ãƒ¼ã‚«ãƒ«æ¤œè¨¼ã¯ `docker compose up db` ã§å³èµ·å‹•ã€‚`COPY` ã‚’ä½¿ã£ãŸãƒãƒ«ã‚¯ãƒ­ãƒ¼ãƒ‰ã¯ IOPS çš„ã« â­•ï¸ ã‚³ã‚¹ãƒ‘æœ€å¼·ã€‚`CREATE INDEX ivfflat` ã‚’ _nprobe=20_ è¾ºã‚Šã§ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹ã¨ã€100 ä¸‡ãƒ¬ã‚³ãƒ¼ãƒ‰ã§ã‚‚ 40 ms ä»¥å†…ã€‚â¤ï¸â€ðŸ©¹

```sql
sql
ã‚³ãƒ”ãƒ¼ã™ã‚‹ç·¨é›†ã™ã‚‹
CREATE EXTENSION IF NOT EXISTS pgvector;
CREATE INDEX IF NOT EXISTS idx_embedding
ON documents USING ivfflat(embedding vector_l2_ops) WITH (lists = 100);

```

## 6. CI/CD ã¨ Observability å°æŠ€é›†

- **GitHub Actions**: Edge Function ç”¨ artifact ã‚’ 5 MB æœªæº€ã«ç¸®ã‚ã‚‹ãŸã‚ `tsx --bundle`
- **Database Migration**: `atlas schema apply` ã‚’ PR ã”ã¨ã« Dry-Run
- **E2E**: Playwright + msw ã§ LLM å‘¼ã³å‡ºã—ã‚’ãƒ¢ãƒƒã‚¯ ( Â´â€¢Ì¥ Ì« â€¢Ì¥ )
- **Tracing**: Vercel Analytics ã ã‘ã§ã¯è¶³ã‚Šãªã„ã®ã§ OTLP ã‚’ Grafana Cloud ã¸ ðŸ”½

## 7. ã¾ã¨ã‚ã¨æŽ¨ã—ãƒã‚¤ãƒ³ãƒˆ

Edge Ã— GraphQL Ã— ç”Ÿæˆ AIã€å…¨éƒ¨ç››ã‚Šã§ã‚‚è¨­è¨ˆã‚’ _ãƒ¬ã‚¤ãƒ¤_ ã§åˆ‡ã‚Œã°ä¿å®ˆã‚‚æ€–ããªã„ï¼

æœ¬è¨˜äº‹ãŒã¿ã‚“ãªã® â€œã„ã„ã­æ¬²â€ ã‚’åˆºæ¿€ã—ã¤ã¤ã€æ¬¡ã®ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯å¦„æƒ³ã®ã‚¿ãƒã«ãªã‚Œã°å¬‰ã—ã„ã§ã™ â£ï¸

è³ªå•ã‚„ã€Œã“ã“ã‚‚ã£ã¨æŽ˜ã‚ŠãŸã„ï¼ã€ãªãƒ„ãƒƒã‚³ãƒŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã§ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€œ â¸â¸> Ì« <â¸â¸Õž
