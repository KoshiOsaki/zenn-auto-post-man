---
title: "LLMæ™‚ä»£ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†è¨­è¨ˆ: Next.js + Go + PostgreSQLã§ä½œã‚‹RAGåŸºç›¤"
emoji: "ðŸ¦"
type: "tech"
topics: ["nextjs", "go", "postgresql", "llm", "rag"]
published: true
---

ã‚„ã£ã»ãƒ¼ï¼( á¢ Ë™ê’³Ë™ á¢ )ðŸ’— ç”Ÿæˆ AI ãƒ–ãƒ¼ãƒ ã§ã€Œã¨ã‚Šã‚ãˆãš RAG ã‚„ã‚ŠãŸã„ï¼ã€ã£ã¦å£°ãŒç¤¾å†…å¤–ã‹ã‚‰é£›ã³äº¤ã†ä»Šæ—¥ã“ã®é ƒã€‚ã ã‘ã© PoC æ­¢ã¾ã‚Šã®ã¾ã¾ç‚Žä¸Š â­ï¸ ã—ã¦ã„ã‚‹æ¡ˆä»¶ã‚‚å¤šãã¦ã€ç¾å ´ã¯ ðŸ’¢ðŸ’¢â€¦ã€‚

ãã“ã§ä»Šå›žã¯ **Next.js + Go + PostgreSQL** ã¨ã„ã†é»„é‡‘ã®ãƒ›ãƒ¼ãƒ ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä½¿ã£ã¦ã€LLM æ™‚ä»£ã«è€ãˆã‚‹ â€œç­‹è‚‰è³ªâ€ ãª RAG åŸºç›¤ã‚’ã‚¼ãƒ­ã‹ã‚‰å†è¨­è¨ˆã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’èªžã‚‹ã‚ˆã€‚

## ç›®æ¬¡

1. RAG ãŒãƒã‚ºã£ã¦ã‚‹ç†ç”±ã‚’ 30 ç§’ã§ãŠã•ã‚‰ã„ ðŸ”½
2. ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“åƒã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ³¨å…¥æˆ¦ç•¥ â¤ï¸â€ðŸ”¥
3. Edge Runtime Ã— Streaming GraphQL ã®è¨­è¨ˆæŒ‡é‡
4. Vector Search ã‚’ Postgres ã§ã‚„ã‚‹ã¹ãã‹å•é¡Œ
5. Docker Compose â†’ k8s ç§»è¡Œã§ãƒãƒžã‚‹ãƒã‚¤ãƒ³ãƒˆ ðŸ’¢
6. è¦³æ¸¬æ€§ã¨ã‚³ã‚¹ãƒˆæœ€é©åŒ– â€“ Tracing ã‹ã‚‰ Infra-as-Code ã¾ã§
7. ä»Šæ—¥ã‹ã‚‰ãƒžãƒã§ãã‚‹å°ã•ãª TODO â­•ï¸

---

### 1. RAG ãŒãƒã‚ºã£ã¦ã‚‹ç†ç”±ã‚’ 30 ç§’ã§ãŠã•ã‚‰ã„ ðŸ”½

RAG (Retrieval-Augmented Generation) ã¯ã€ŒLLM ã®å¹»è¦šã‚’æŠ‘ãˆã¤ã¤ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³çŸ¥è­˜ã‚’å©ãè¾¼ã¿ãŸã„ã€ã¨ã„ã†ãƒ¯ã‚¬ãƒžãƒžã‚’å®Ÿç¾ã™ã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€‚ãƒã‚¤ãƒ³ãƒˆã¯ **â€œãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å±¤â€ ã¨ â€œãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆå±¤â€ ã‚’åˆ†é›¢** ã§ãã‚‹ã“ã¨ã§ã€å¾“æ¥ã® MVC ãƒ¢ãƒŽãƒªã‚¹ã«å¼·å¼•ã«æŠ¼ã—è¾¼ã‚€ã¨ç¢ºå®Ÿã«å£Šã‚Œã‚‹ã€‚æŠ½è±¡çš„ã«ã¯ _â€œæ¤œç´¢ã¨ç”Ÿæˆã®è²¬å‹™åˆ†å‰²â€_ ãŒãƒ†ãƒ¼ãƒžã ã‚ˆã€‚

### 2. ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“åƒã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ³¨å…¥æˆ¦ç•¥ â¤ï¸â€ðŸ”¥

Next.js ã‚’ã‚¨ãƒƒã‚¸é…ç½®ã—ã€API Routes ã‹ã‚‰ Go è£½ BFF ã¸ GraphQL over HTTP/2 ã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã€‚ãƒ•ãƒ­ãƒ³ãƒˆã¯ React Server Components ã§ã€Œæ¤œç´¢ â†’ ç”Ÿæˆ â†’ ã‚¹ãƒˆãƒªãƒ¼ãƒ è¡¨ç¤ºã€ã‚’ãƒŽãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã«å®Ÿç¾ã€‚æ–‡æ›¸åˆ†å‰²ã¯ _recursive-character-text-splitter_ ã‚’ä½¿ã„ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯ JSONB ã§ Postgres ã®åŒä¸€ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯„ã›ã¦ãŠãã¨ JOIN åœ°ç„ã‚’å›žé¿ã§ãã‚‹ã€‚(à¸…â€¢Ï‰â€¢à¸…)

### 3. Edge Runtime Ã— Streaming GraphQL ã®è¨­è¨ˆæŒ‡é‡

æ™®é€šã® REST ã ã¨ chunked-response ã‚’è‡ªå‰å®Ÿè£…ã—ãŒã¡ã ã‘ã©ã€GraphQL ãªã‚‰ **@defer/@stream** æŒ‡ä»¤ã§è§£æ±ºã€‚Go å´ã¯ `gqlgen` + `http2` ã§ Push Promiseã€‚ã“ã“ã§é‡è¦ãªã®ã¯ã€ŒLLM ãŒè¿”ã™ tokenã€ã‚’ãã®ã¾ã¾ node ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«æµã™ã®ã§ã¯ãªãã€**cursor ãƒ™ãƒ¼ã‚¹ã® incremental payload** ã«å¤‰æ›ã™ã‚‹ã“ã¨ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ React 18 ã® `use` ã§å¾…æ©Ÿã§ãã‚‹ã‹ã‚‰ UX ãŒåŠ‡çš„ã«ä¸ŠãŒã‚‹ã€‚

### 4. Vector Search ã‚’ Postgres ã§ã‚„ã‚‹ã¹ãã‹å•é¡Œ

å¤–éƒ¨ Vector DB (Pinecone ç­‰) ã¯æ¥½ã ã‘ã©ã€**ã‚³ã‚¹ãƒˆã¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒçˆ†å¢—** âš ï¸ã€‚Postgres 16 + `pgvector` ãªã‚‰ **same-process JOIN** ãŒåˆ©ãã®ã§ ACID è¦ä»¶ãŒé«˜ã„ SaaS ã§ã¯æœ‰åˆ©ã€‚

ãŸã ã— _HNSW_ index ã¯ RAM ãƒ¢ãƒªãƒ¢ãƒªæ¶ˆè²»ã™ã‚‹ã‹ã‚‰ã€`max_connections` ã‚’çµžã‚Šã¤ã¤ **connection_pool â†” RPS â†” vector size** ã® 3 å¤‰æ•°ã‚’ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹è¨­è¨ˆãŒå¿…é ˆã€‚

### 5. Docker Compose â†’ k8s ç§»è¡Œã§ãƒãƒžã‚‹ãƒã‚¤ãƒ³ãƒˆ ðŸ’¢

åˆæœŸã¯ Compose ãŒæœ€é€Ÿã ã‘ã©ã€RAG ã®ãƒãƒƒãƒã‚¤ãƒ³ãƒ‡ã‚¯ã‚µã¯çªç™ºçš„ã« CPU ã‚’é£Ÿã†ã€‚k8s ã§ **HorizontalPodAutoscaler + CronJob** ã«åˆ†é›¢ã—ãªã„ã¨ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒå…¨ä½“ã‚’å·»ãè¾¼ã‚€ã‚ˆã€‚

ãã‚Œã¨ Secretsã€‚ç’°å¢ƒå¤‰æ•°ã« OpenAI key ã‚’ãƒ™ã‚¿æ›¸ãã™ã‚‹ã¨å³æ­»ãªã®ã§ã€`SealedSecrets` or `External Secrets` Controller ã§ GitOps ã™ã‚‹ã®ãŒæœ€é©è§£ã€‚

### 6. è¦³æ¸¬æ€§ã¨ã‚³ã‚¹ãƒˆæœ€é©åŒ– â€“ Tracing ã‹ã‚‰ Infra-as-Code ã¾ã§

- **Tracing:** OpenTelemetry + Jaeger ã§ token-level latency ã‚’è¨ˆæ¸¬ã—ã€prompt æ”¹å–„ã‚ˆã‚Šãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ”¹å–„ãŒåŠ¹ãã‚±ãƒ¼ã‚¹ã‚’æ•°å€¤ã§è¨¼æ˜Žã€‚
- **IaC:** Terraform ã§ Cloud Run / Cloud SQL / Cloud Storage ã‚’ç®¡ç†ã—ã€`tfsec`, `infracost` ã‚’ CI ã«çµ„ã¿è¾¼ã‚€ã¨ FinOps ã‚‚è‡ªå‹•åŒ–ã§ãã‚‹ã€‚
- **LLM Cost Guard:** Go ã® middleware ã« **tokencounter** ã‚’æŒŸã‚“ã§ä½¿ç”¨é‡ã‚’ headers ã«ã‚¨ã‚³ãƒ¼ãƒãƒƒã‚¯ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã® DevTools ã ã‘ã§æœˆé¡ã‚’è¦‹ç©ã‚‚ã‚Œã‚‹ã®ãŒä½“é¨“ç¥žã€‚

### 7. ä»Šæ—¥ã‹ã‚‰ãƒžãƒã§ãã‚‹å°ã•ãª TODO â­•ï¸

1. `pgvector` æ‹¡å¼µã‚’å…¥ã‚Œã¦ `CREATE INDEX ON docs USING ivfflat (embedding vector_cosine_ops);`
2. Next.js ã® `app/` é…ä¸‹ã§ `route.ts` ã« `ReadableStream` ã‚µãƒ³ãƒ—ãƒ«ã‚’ç½®ã
3. Go BFF ã« `otelgrpc` ã‚’å™›ã¾ã›ã¦ Jaeger ã¸ export
4. Makefile ã« `make cost` ã‚’è¿½åŠ ã—ã¦ infracost ã‚’å³è¦‹

---

## ãŠã‚ã‚Šã«

RAG ã¯é­”æ³•ã˜ã‚ƒãªã„ã—ã€ŒLLM ã‚’ DB ã«ã¤ãªã’ã° OKã€ã§ã‚‚ãªã„ã€‚æ¤œç´¢å±¤ãƒ»ç”Ÿæˆå±¤ãƒ»è¦³æ¸¬å±¤ãã‚Œãžã‚Œã® _æŠ½è±¡åº¦ã‚’ä¸Šã’ã¦è²¬å‹™åˆ†é›¢_ ã™ã‚‹ã“ã¨ã§ã€ã‚¹ã‚±ãƒ¼ãƒ«ã‚‚ãƒ‡ãƒãƒƒã‚°ã‚‚ãã£ã¨ãƒ©ã‚¯ã«ãªã‚‹ã‚ˆ â£ï¸

ã“ã®è¨˜äº‹ãŒã€ŒPoC æ­¢ã¾ã‚Šã§æ³£ã„ã¦ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã€ã‚’ â¤ï¸â€ðŸ©¹ æ•‘ã†ãƒ’ãƒ³ãƒˆã«ãªã‚Œã°å¬‰ã—ã„ãªï½žã€‚ãã‚Œã§ã¯ã¾ãŸæ¬¡ã®è¨˜äº‹ã§ï¼â¸â¸> Ì« <â¸â¸Õž
